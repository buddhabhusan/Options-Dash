<!DOCTYPE html>
<html>
<head>
    <title>Options Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .navbar-custom {
            background: var(--primary-gradient);
        }
        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
        }
        .btn-custom {
            background: var(--primary-gradient);
            border: none;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 25px;
        }
        .surface-container {
            height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 25px;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom mb-4 shadow-lg py-3">
      <div class="container-fluid d-flex flex-column flex-md-row align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="fas fa-chart-line me-3 text-white" style="font-size: 2rem;"></i>
          <span class="navbar-brand mb-0 h1 display-5 fw-bold text-white" style="font-size:2.2rem;">Options Dashboard</span>
          <span class="badge bg-white text-primary ms-3 fs-6 px-3 py-2 rounded-pill">
            <i class="fas fa-calendar-alt me-1"></i>Expiry: <span class="fw-semibold">{{ expiry }}</span>
          </span>
        </div>
      </div>
    </nav>

    <div class="container-fluid px-4">
      <div class="row justify-content-center">
        <div class="col-lg-11">
          <div class="card card-custom mb-4">
            <div class="card-header bg-white border-bottom-0 pt-4">
              <div class="d-flex justify-content-between align-items-center">
                <ul class="nav nav-pills">
                  <li class="nav-item">
                    <a class="nav-link active rounded-pill px-4" data-bs-toggle="tab" href="#greeks">
                      <i class="fas fa-calculator me-2"></i>Greek Calculator
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link rounded-pill px-4 ms-2" data-bs-toggle="tab" href="#iv">
                      <i class="fas fa-cube me-2"></i>3D Volatility Surface
                    </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link rounded-pill px-4 ms-2" data-bs-toggle="tab" href="#backtest">
                          <i class="fas fa-cogs me-2"></i>Backtesting
                      </a>
                  </li>
                </ul>
                <div class="d-flex align-items-center text-muted">
                  <i class="fas fa-info-circle me-2"></i>
                  <small>Real-time options analysis</small>
                </div>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="tab-content">
                <div class="tab-pane fade show active" id="greeks">
                  <div class="row mb-4 align-items-end">
                    <div class="col-md-3">
                      <label for="rval" class="form-label fw-semibold text-dark">
                        <i class="fas fa-percentage me-2 text-primary"></i>Risk Free Rate (%)
                      </label>
                      <input id="rval" type="number" step="0.01" min="0" max="1" placeholder="0.15" class="form-control form-control-lg" value="0.15"/>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label fw-semibold text-dark">
                        <i class="fas fa-filter me-2 text-primary"></i>Filter Options
                      </label>
                      <select id="optionFilter" class="form-select form-select-lg">
                        <option value="all">All Options</option>
                        <option value="call">Calls Only</option>
                        <option value="put">Puts Only</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <button onclick="loadGreeks()" class="btn btn-custom btn-lg w-100 text-white fw-semibold">
                        <i class="fas fa-chart-bar me-2"></i>Plot Greeks
                      </button>
                    </div>
                    <div class="col-md-2">
                      <button onclick="clearCharts()" class="btn btn-outline-secondary btn-lg w-100">
                        <i class="fas fa-trash me-2"></i>Clear
                      </button>
                    </div>
                  </div>
                  
                  <div class="row mb-4">    
                    <div class="col-12">
                      <div class="card border-0" style="background: linear-gradient(45deg, #f8f9fa, #e9ecef);">
                        <div class="card-body p-3">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <label class="form-label fw-semibold text-dark mb-0">
                                <i class="fas fa-calendar-range me-2 text-primary"></i>Date Range
                              </label>
                            </div>
                            <div class="col-md-3">
                              <label for="startDate" class="form-label text-muted small">Start Date</label>
                              <input type="date" id="startDate" class="form-control" value="2023-12-28"/>
                            </div>
                            <div class="col-md-3">
                              <label for="endDate" class="form-label text-muted small">End Date</label>
                              <input type="date" id="endDate" class="form-control" value="2023-12-28"/>
                            </div>
                            <div class="col-md-2">
                              <button onclick="applyDateFilter()" class="btn btn-outline-primary w-100 mt-3 mt-md-4">
                                <i class="fas fa-filter me-2"></i>Apply
                              </button>
                            </div>
                            <div class="col-md-2">
                              <button onclick="resetDateFilter()" class="btn btn-outline-secondary w-100 mt-3 mt-md-4">
                                <i class="fas fa-undo me-2"></i>Reset
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-12">
                      <div class="alert alert-info border-0 rounded-3" style="background: linear-gradient(45deg, #e3f2fd, #f3e5f5);">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-lightbulb text-warning me-3" style="font-size: 1.5rem;"></i>
                          <div>
                            <strong>Quick Guide:</strong> Delta measures price sensitivity, Gamma shows delta's rate of change, 
                            Theta indicates time decay, Vega shows volatility sensitivity, and Rho measures interest rate sensitivity.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div id="spinner" class="text-center my-5" style="display:none;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-3 text-primary fw-semibold">Loading data, please wait...</div>
                  </div>
                  <div id="errorMsg" class="alert alert-danger border-0 rounded-3" style="display:none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                  </div>
                  <div id="greekCharts" class="row"></div>
                </div>
                
                <!-- 3D Implied Volatility Surface Tab -->
                <div class="tab-pane fade" id="iv">
                  <div class="row mb-4 align-items-end">
                    <div class="col-md-3">
                      <label for="ivRval" class="form-label fw-semibold text-dark">
                        <i class="fas fa-percentage me-2 text-primary"></i>Risk Free Rate (%)
                      </label>
                      <input id="ivRval" type="number" step="0.01" min="0" max="1" placeholder="0.15" class="form-control form-control-lg" value="0.15"/>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label fw-semibold text-dark">
                        <i class="fas fa-filter me-2 text-primary"></i>Option Type
                      </label>
                      <select id="ivOptionFilter" class="form-select form-select-lg">
                        <option value="call">Calls Surface</option>
                        <option value="put">Puts Surface</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <button onclick="load3DIV()" class="btn btn-custom btn-lg w-100 text-white fw-semibold">
                        <i class="fas fa-cube me-2"></i>Plot 3D Surface
                      </button>
                    </div>
                    <div class="col-md-2">
                      <button onclick="clearIVCharts()" class="btn btn-outline-secondary btn-lg w-100">
                        <i class="fas fa-trash me-2"></i>Clear
                      </button>
                    </div>
                  </div>                  
                  <div class="row mb-4">
                    <div class="col-12">
                      <div class="card border-0" style="background: linear-gradient(45deg, #f8f9fa, #e9ecef);">
                        <div class="card-body p-3">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <label class="form-label fw-semibold text-dark mb-0">
                                <i class="fas fa-calendar-range me-2 text-primary"></i>Date Range
                              </label>
                            </div>
                            <div class="col-md-3">
                              <label for="ivStartDate" class="form-label text-muted small">Start Date</label>
                              <input type="date" id="ivStartDate" class="form-control" value="2023-12-01"/>
                            </div>
                            <div class="col-md-3">
                              <label for="ivEndDate" class="form-label text-muted small">End Date</label>
                              <input type="date" id="ivEndDate" class="form-control" value="2023-12-28"/>
                            </div>
                            <div class="col-md-2">
                              <button onclick="applyIVDateFilter()" class="btn btn-outline-primary w-100 mt-3 mt-md-4">
                                <i class="fas fa-filter me-2"></i>Apply
                              </button>
                            </div>
                            <div class="col-md-2">
                              <button onclick="resetIVDateFilter()" class="btn btn-outline-secondary w-100 mt-3 mt-md-4">
                                <i class="fas fa-undo me-2"></i>Reset
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-12">
                      <div class="alert alert-info border-0 rounded-3" style="background: linear-gradient(45deg, #e8f5e8, #f0f8ff);">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-cube text-info me-3" style="font-size: 1.5rem;"></i>
                          <div>
                            <strong>3D Volatility Surface:</strong> This surface shows how implied volatility changes across different strike prices over time. 
                            Higher peaks indicate greater expected volatility. You can rotate, zoom, and hover for detailed values.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div id="ivSpinner" class="text-center my-5" style="display:none;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-3 text-primary fw-semibold">Building 3D volatility surface...</div>
                  </div>
                  <div id="ivErrorMsg" class="alert alert-danger border-0 rounded-3" style="display:none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                  </div>
                  <div id="ivSurface" class="surface-container" style="display:none;"></div>
                </div>
                

                <!-- New Backtesting Tab -->
                <div class="tab-pane fade" id="backtest">
                  <div class="row mb-4 align-items-end">
                    <!-- Delta/Vega Neutral Definitions -->
                    <p class="text-muted mb-2">
                      <strong>Delta Neutral:</strong> Position is initially unaffected by small changes in the price of the underlying.<br>
                      <strong>Vega Neutral:</strong> Position is unaffected by changes in implied volatility.
                    </p>
                    
                    <!-- Strategy Selection + Info -->
                    <div class="row g-3">
                      <!-- Strategy Dropdown -->
                      <div class="col-md-4">
                        <label for="strategySelect" class="form-label fw-semibold text-dark">
                          <i class="fas fa-cogs me-2 text-primary"></i>Select Strategy
                        </label>
                        <select id="strategySelect" class="form-select form-select-lg">
                          <option value="" disabled selected>Select a strategy</option>
                          <option value="straddle">Straddle</option>
                          <option value="butterfly">Butterfly</option>
                        </select>
                      </div>
                    
                      <!-- Strategy Info Box (Full Width Below) -->
                      <div class="col-12" id="strategyInfoBox">
                        <div class="alert alert-secondary mt-2" id="strategyDescription">
                          <strong>Strategy Info:</strong> Please select a strategy to see the description.
                        </div>
                      </div>
                    
                      <!-- Buttons -->
                      <div class="col-md-2">
                        <button onclick="runBacktest()" class="btn btn-success btn-lg w-100 text-white fw-semibold">
                          <i class="fas fa-play me-2"></i>Run Backtest
                        </button>
                      </div>
                      <div class="col-md-2">
                        <button onclick="clearBacktestResult()" class="btn btn-outline-secondary btn-lg w-100">
                          <i class="fas fa-trash me-2"></i>Clear
                        </button>
                      </div>
                    </div>

                  <!-- New Quick Guide: Backtesting -->
                    <div class="row mb-3">
                      <div class="col-12">
                        <div class="alert alert-info border-0 rounded-3" style="background: linear-gradient(45deg, #e3f2fd, #f3e5f5);">
                          <div class="d-flex align-items-center">
                            <i class="fas fa-chart-line text-primary me-3" style="font-size: 1.5rem;"></i>
                            <div>
                              <strong>Backtesting Guide:</strong> Backtesting simulates trading strategies on historical data to estimate performance before risking real capital. It helps refine parameters, understand risks, and evaluate profitability over time.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                
                
                  <!-- Results section -->
                  <div id="backtestResult" class="mt-4"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    

<script>
function clearCharts() {
    document.getElementById('greekCharts').innerHTML = '';
}

function applyDateFilter() {
    loadGreeks();
}

function resetDateFilter() {
    document.getElementById('startDate').value = '2023-12-28';
    document.getElementById('endDate').value = '2023-12-28';
    loadGreeks();
}

function filterDataByDate(data) {
    const startDate = new Date(document.getElementById('startDate').value);
    const endDate = new Date(document.getElementById('endDate').value);
    
    // Set time to cover full day range
    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(23, 59, 59, 999);
    
    const filteredData = {};
    
    for (const [label, points] of Object.entries(data)) {
        const filteredPoints = points.filter(point => {
            const pointDate = new Date(point.datetime);
            return pointDate >= startDate && pointDate <= endDate;
        });
        
        if (filteredPoints.length > 0) {
            filteredData[label] = filteredPoints;
        }
    }
    
    return filteredData;
}

function filterMarketHours(data) {
    // Handle different data structures - if it's already an array, process directly
    if (Array.isArray(data)) {
        return data.filter(point => {
            const time = new Date(point.datetime);
            const hours = time.getHours();
            const minutes = time.getMinutes();
            const timeInMinutes = hours * 60 + minutes;
            
            // Market hours: 9:30 AM to 3:30 PM (570 to 930 minutes)
            return timeInMinutes >= 570 && timeInMinutes <= 930;
        });
    }
    
    // Handle object structure (for Greeks data)
    const filteredData = {};
    
    for (const [label, points] of Object.entries(data)) {
        if (!Array.isArray(points)) {
            console.warn('Expected array for points, got:', typeof points, points);
            continue;
        }
        
        const marketHoursPoints = points.filter(point => {
            const time = new Date(point.datetime);
            const hours = time.getHours();
            const minutes = time.getMinutes();
            const timeInMinutes = hours * 60 + minutes;
            
            // Market hours: 9:30 AM to 3:30 PM (570 to 930 minutes)
            return timeInMinutes >= 570 && timeInMinutes <= 930;
        });
        
        if (marketHoursPoints.length > 0) {
            filteredData[label] = marketHoursPoints;
        }
    }
    
    return filteredData;
}

function loadGreeks() {
    const r = document.getElementById('rval').value;
    const filter = document.getElementById('optionFilter').value;
    const spinner = document.getElementById('spinner');
    const errorMsg = document.getElementById('errorMsg');
    const container = document.getElementById('greekCharts');
    
    spinner.style.display = '';
    errorMsg.style.display = 'none';
    container.innerHTML = '';

    fetch(`/api/greeks/?r=${r}`)
        .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        })
        .then(res => {
            spinner.style.display = 'none';
            
            // Apply date filtering first, then market hours filtering
            let filteredData = filterDataByDate(res.data || res);
            filteredData = filterMarketHours(filteredData);
            
            const greeks = ['delta', 'vega', 'theta'];
            const colors = {
                'delta': '#ff6b6b',
                'vega': '#4ecdc4', 
                'theta': '#45b7d1'
            };

            let chartCount = 0;
            for (const [label, points] of Object.entries(filteredData)) {
                const [strike, opt_type] = label.split('_');
                
                // Apply option type filter
                if (filter !== 'all' && opt_type !== filter) continue;
                
                if (points.length === 0) continue; // Skip if no data points
                
                const traces = greeks.map(greek => ({
                    x: points.map(p => p.datetime),
                    y: points.map(p => p[greek]),
                    mode: 'lines',
                    name: greek.toUpperCase(),
                    line: { 
                        color: colors[greek], 
                        width: 3,
                        shape: 'spline'
                    }
                }));

                const layout = {
                    title: {
                        text: `<b>Strike: ${strike} | Type: ${opt_type.toUpperCase()}</b>`,
                        font: { size: 18, color: '#2c3e50' }
                    },
                    xaxis: { 
                        title: 'Time',
                        titlefont: { size: 14, color: '#7f8c8d' },
                        gridcolor: '#ecf0f1'
                    },
                    yaxis: { 
                        title: 'Greek Value',
                        titlefont: { size: 14, color: '#7f8c8d' },
                        gridcolor: '#ecf0f1'
                    },
                    height: 400,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    legend: {
                        orientation: 'h',
                        x: 0.5,
                        xanchor: 'center',
                        y: -0.2
                    },
                    margin: { t: 80, l: 60, r: 30, b: 80 }
                };

                const col = document.createElement('div');
                col.className = 'col-xl-6 col-lg-12 mb-4';
                
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                col.appendChild(chartContainer);
                container.appendChild(col);
                
                Plotly.newPlot(chartContainer, traces, layout, {responsive: true});
                chartCount++;
            }
            
            if (chartCount === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-calendar-times text-muted" style="font-size: 4rem;"></i>
                        <h4 class="text-muted mt-3">No data found for the selected date range</h4>
                        <p class="text-muted">Try adjusting the date range or check your data files for available dates.</p>
                        <button onclick="resetDateFilter()" class="btn btn-primary mt-3">
                            <i class="fas fa-undo me-2"></i>Reset Date Filter
                        </button>
                    </div>
                `;
            }
        })
        .catch(err => {
            spinner.style.display = 'none';
            errorMsg.style.display = '';
            errorMsg.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Failed to load data. Please try again later.';
        });
}

// 3D Implied Volatility Functions
function clearIVCharts() {
    document.getElementById('ivSurface').style.display = 'none';
    document.getElementById('ivSurface').innerHTML = '';
}

function applyIVDateFilter() {
    load3DIV();
}

function resetIVDateFilter() {
    document.getElementById('ivStartDate').value = '2023-12-01';
    document.getElementById('ivEndDate').value = '2023-12-28';
    load3DIV();
}

function filterIVDataByDate(data) {
    const startDate = new Date(document.getElementById('ivStartDate').value);
    const endDate = new Date(document.getElementById('ivEndDate').value);
    
    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(23, 59, 59, 999);
    
    const filteredData = {};
    
    for (const [label, points] of Object.entries(data)) {
        const filteredPoints = points.filter(point => {
            const pointDate = new Date(point.datetime);
            return pointDate >= startDate && pointDate <= endDate;
        });
        
        if (filteredPoints.length > 0) {
            filteredData[label] = filteredPoints;
        }
    }
    
    return filteredData;
}

// Helper function to interpolate missing values
function interpolateMatrix(matrix, xValues, yValues) {
    const rows = matrix.length;
    const cols = matrix[0].length;
    
    // Fill missing values with linear interpolation
    for (let i = 0; i < rows; i++) {
        for (let j = 0; j < cols; j++) {
            if (matrix[i][j] === null) {
                // Try to find nearest valid values
                let leftVal = null, rightVal = null;
                let topVal = null, bottomVal = null;
                
                // Search horizontally
                for (let k = j - 1; k >= 0 && leftVal === null; k--) {
                    if (matrix[i][k] !== null) leftVal = matrix[i][k];
                }
                for (let k = j + 1; k < cols && rightVal === null; k++) {
                    if (matrix[i][k] !== null) rightVal = matrix[i][k];
                }
                
                // Search vertically
                for (let k = i - 1; k >= 0 && topVal === null; k--) {
                    if (matrix[k][j] !== null) topVal = matrix[k][j];
                }
                for (let k = i + 1; k < rows && bottomVal === null; k++) {
                    if (matrix[k][j] !== null) bottomVal = matrix[k][j];
                }
                
                // Interpolate based on available neighbors
                const neighbors = [leftVal, rightVal, topVal, bottomVal].filter(v => v !== null);
                if (neighbors.length > 0) {
                    matrix[i][j] = neighbors.reduce((sum, val) => sum + val, 0) / neighbors.length;
                }
            }
        }
    }
    
    return matrix;
}

function load3DIV() {
    const r = document.getElementById('ivRval').value;
    const optionType = document.getElementById('ivOptionFilter').value;
    const spinner = document.getElementById('ivSpinner');
    const errorMsg = document.getElementById('ivErrorMsg');
    const container = document.getElementById('ivSurface');
    
    spinner.style.display = '';
    errorMsg.style.display = 'none';
    container.style.display = 'none';
    container.innerHTML = '';

    fetch(`/api/iv/?r=${r}`)
        .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        })
        .then(res => {
            spinner.style.display = 'none';
            console.log('IV API response:', res);
            
            // Apply date filtering first, then market hours filtering
            let filteredData = filterIVDataByDate(res.data || res);
            console.log('After date filtering:', Object.keys(filteredData).length, 'files');
            
            filteredData = Object.fromEntries(
                Object.entries(filteredData).map(([label, points]) => {
                    const filteredPoints = filterMarketHours(points);
                    return [label, filteredPoints];
                }).filter(([label, points]) => points.length > 0)
            );
            
            // Filter by option type and prepare data for 3D surface
            const surfaceData = [];
            const strikes = new Set();
            const times = new Set();
            
            for (const [label, points] of Object.entries(filteredData)) {
                const [strike, opt_type] = label.split('_');
                
                // Filter by option type
                if (opt_type !== optionType) continue;
                
                const strikeNum = parseFloat(strike);
                strikes.add(strikeNum);
                
                points.forEach(point => {
                    // Only include valid IV values
                    if (point.iv !== null && point.iv !== undefined && !isNaN(point.iv) && point.iv > 0) {
                        times.add(point.datetime);
                        surfaceData.push({
                            strike: strikeNum,
                            time: point.datetime,
                            iv: point.iv
                        });
                    }
                });
            }
            
            if (surfaceData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-chart-area text-muted" style="font-size: 4rem;"></i>
                        <h4 class="text-muted mt-3">No IV data found for ${optionType}s</h4>
                        <p class="text-muted">Try adjusting the date range or check your data files.</p>
                    </div>
                `;
                container.style.display = '';
                return;
            }
            
            // Convert sets to sorted arrays
            const sortedStrikes = Array.from(strikes).sort((a, b) => a - b);
            const sortedTimes = Array.from(times).sort();
            
            // Sample data points for smoother surface (take every nth point for performance)
            const maxTimePoints = 50;
            const timeStep = Math.max(1, Math.floor(sortedTimes.length / maxTimePoints));
            const sampledTimes = sortedTimes.filter((_, i) => i % timeStep === 0);
            
            // Create Z matrix for surface plot
            const zMatrix = [];
            
            // Initialize matrix with null values
            for (let i = 0; i < sampledTimes.length; i++) {
                zMatrix[i] = new Array(sortedStrikes.length).fill(null);
            }
            
            // Fill the Z matrix with IV values
            surfaceData.forEach(point => {
                const timeIndex = sampledTimes.findIndex(t => 
                    Math.abs(new Date(t).getTime() - new Date(point.time).getTime()) < 60000 // within 1 minute
                );
                const strikeIndex = sortedStrikes.indexOf(point.strike);
                if (timeIndex !== -1 && strikeIndex !== -1) {
                    zMatrix[timeIndex][strikeIndex] = point.iv;
                }
            });
            
            // Interpolate missing values for smoother surface
            interpolateMatrix(zMatrix, sampledTimes, sortedStrikes);
            
            // Create 3D surface plot with highly distinctive heatmap colors
            const trace = {
                type: 'surface',
                x: sampledTimes,
                y: sortedStrikes,
                z: zMatrix,
                colorscale: [
                    [0.0, '#440154'],    // Dark purple (lowest volatility)
                    [0.1, '#3B528B'],    // Deep blue
                    [0.2, '#21908C'],    // Teal
                    [0.3, '#26838F'],    // Blue-green
                    [0.4, '#35B779'],    // Green
                    [0.5, '#6DCD59'],    // Bright green
                    [0.6, '#B4DE2C'],    // Yellow-green
                    [0.7, '#FDE725'],    // Bright yellow
                    [0.8, '#FF6B35'],    // Orange
                    [0.9, '#E63946'],    // Red
                    [1.0, '#B91372']     // Magenta-red (highest volatility)
                ],
                surfacecolor: zMatrix, // Ensure color mapping works properly
                cmin: Math.min(...zMatrix.flat().filter(v => v !== null)),
                cmax: Math.max(...zMatrix.flat().filter(v => v !== null)),
                opacity: 0.98,
                lighting: {
                    ambient: 0.6,
                    diffuse: 0.7,
                    specular: 0.3,
                    roughness: 0.05,
                    fresnel: 0.3
                },
                contours: {
                    z: {
                        show: true,
                        usecolormap: false,
                        color: '#FFFFFF',
                        width: 3,
                        project: { z: true }
                    }
                },
                colorbar: {
                    title: {
                        text: 'üå°Ô∏è Volatility Heat Index',
                        font: { size: 14, color: '#2c3e50', family: 'Arial, sans-serif' }
                    },
                    titleside: 'right',
                    tickformat: '.1%',
                    thickness: 30,
                    len: 0.85,
                    bgcolor: 'rgba(255, 255, 255, 0.95)',
                    bordercolor: '#34495e',
                    borderwidth: 2,
                    tickfont: { size: 12, color: '#2c3e50' },
                    tickmode: 'linear',
                    tick0: 0,
                    dtick: 0.05
                },
                hovertemplate: '<b>üéØ Strike:</b> ‚Çπ%{y}<br>' +
                               '<b>‚è∞ Time:</b> %{x}<br>' +
                               '<b>üìà IV:</b> %{z:.2%}<br>' +
                               '<extra></extra>',
                hoverlabel: {
                    bgcolor: 'rgba(255, 255, 255, 0.95)',
                    bordercolor: '#34495e',
                    font: { size: 13, color: '#2c3e50' }
                }
            };
            
            const layout = {
                title: {
                    text: `<b>3D Volatility Heatmap Surface - ${optionType.toUpperCase()}S</b><br>`,
                    font: { size: 22, color: '#2c3e50', family: 'Arial, sans-serif' },
                    x: 0.5,
                    xanchor: 'center'
                },
                scene: {
                    xaxis: {
                        title: {
                            text: '‚è∞ Time',
                            font: { size: 16, color: '#34495e', family: 'Arial, sans-serif' }
                        },
                        tickfont: { size: 11, color: '#7f8c8d' },
                        gridcolor: 'rgba(128, 128, 128, 0.4)',
                        backgroundcolor: 'rgba(248, 248, 255, 0.3)',
                        showbackground: true
                    },
                    yaxis: {
                        title: {
                            text: 'üéØ Strike Price (‚Çπ)',
                            font: { size: 16, color: '#34495e', family: 'Arial, sans-serif' }
                        },
                        tickfont: { size: 11, color: '#7f8c8d' },
                        gridcolor: 'rgba(128, 128, 128, 0.4)',
                        backgroundcolor: 'rgba(255, 248, 248, 0.3)',
                        showbackground: true
                    },
                    zaxis: {
                        title: {
                            text: 'üìà Implied Volatility (%)',
                            font: { size: 16, color: '#34495e', family: 'Arial, sans-serif' }
                        },
                        tickformat: '.1%',
                        tickfont: { size: 11, color: '#7f8c8d' },
                        gridcolor: 'rgba(128, 128, 128, 0.4)',
                        backgroundcolor: 'rgba(248, 255, 248, 0.3)',
                        showbackground: true
                    },
                    camera: {
                        eye: { x: 2.2, y: 2.2, z: 1.4 },
                        up: { x: 0, y: 0, z: 1 },
                        center: { x: 0, y: 0, z: -0.15 }
                    },
                    bgcolor: 'rgba(250, 250, 250, 0.95)',
                    aspectratio: { x: 1.4, y: 1, z: 0.8 }
                },
                height: 680,
                paper_bgcolor: 'rgba(255, 255, 255, 1.0)',
                plot_bgcolor: 'rgba(250, 250, 250, 0.95)',
                margin: { t: 110, l: 20, r: 50, b: 30 },
                font: { family: 'Arial, sans-serif', color: '#2c3e50' },
                annotations: [
                    {
                        text: "üåà <b>Color Guide:</b> Purple/Blue = Low volatility zones | Green/Yellow = Medium | Orange/Red = High volatility peaks",
                        showarrow: false,
                        xref: "paper", yref: "paper",
                        x: 0.5, y: -0.05, xanchor: 'center', yanchor: 'top',
                        font: { size: 12, color: '#7f8c8d' },
                        bgcolor: 'rgba(255, 255, 255, 0.9)',
                        bordercolor: '#bdc3c7',
                        borderwidth: 1
                    }
                ]
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToAdd: ['resetCameraDefault3d'],
                displaylogo: false,
                toImageButtonOptions: {
                    format: 'png',
                    filename: `${optionType}_volatility_surface`,
                    height: 600,
                    width: 800,
                    scale: 2
                }
            };
            
            container.style.display = '';
            Plotly.newPlot(container, [trace], layout, config);
            
        })
        .catch(err => {
            spinner.style.display = 'none';
            errorMsg.style.display = '';
            console.error('3D IV loading error:', err);
            errorMsg.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Failed to load 3D IV surface: ' + err.message + '. Please check the browser console for details.';
        });
}
const strategyDescriptions = {
  straddle: `
    <strong>Straddle:</strong> A <em>delta-neutral</em> options strategy involving buying both a call and a put option with the same strike price and expiry.<br>
    <ul>
      <li>Profits from large price movements in either direction.</li>
      <li><strong>Delta Neutral:</strong> Initially, the net delta is close to zero, meaning the position is not sensitive to small price movements.</li>
      <li><strong>Not Vega Neutral:</strong> Gains if implied volatility increases, since both options benefit from volatility.</li>
    </ul>
  `,
  strangle: `
    <strong>Strangle:</strong> A variation of the straddle, where you buy an out-of-the-money call and put (different strike prices).<br>
    <ul>
      <li>Cheaper than a straddle but needs a bigger move to be profitable.</li>
      <li><strong>Delta Neutral:</strong> Like a straddle, initial net delta is close to zero.</li>
      <li><strong>Not Vega Neutral:</strong> Benefits from an increase in implied volatility.</li>
    </ul>
  `,
  butterfly: `
    <strong>Butterfly Spread:</strong> A non-directional strategy combining bull and bear spreads (typically 3 options).<br>
    <ul>
      <li>Profits when the underlying stays close to the middle strike.</li>
      <li><strong>Not Delta Neutral:</strong> The position can be delta-neutral only near the middle strike, but this varies over time.</li>
      <li><strong>Not Vega Neutral:</strong> Typically loses value as volatility increases.</li>
    </ul>
  `
};

function runBacktest() {
  const strategy = document.getElementById("strategySelect").value;

  fetch(`/api/backtest?strategy=${strategy}`)
    .then(res => {
      if (!res.ok) {
        throw new Error(`Server error: ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      const result = data.result;

      const message = result.message || "No message";
      const totalTrades = result.total_trades ?? "N/A";
      const wins = result.wins ?? "N/A";
      const winRate = result.win_rate ?? "N/A";
      const finalCapital = result.final_capital ?? "N/A";
      const pnl = result.total_pnl ?? "N/A";
      const currency = result.currency || "";
      const maxDrawdown = result.max_drawdown ?? "N/A";
      const sharpe = result.annualized_sharpe_ratio ?? "N/A";

      document.getElementById("backtestResult").innerHTML = `
        <div class="alert alert-info">
          <h5>Backtest Results</h5>
          <p><strong>Strategy:</strong> ${data.strategy}</p>
          <p><strong>Message:</strong> ${message}</p>
          <p><strong>Total Trades:</strong> ${totalTrades}</p>
          <p><strong>Wins:</strong> ${wins}</p>
          <p><strong>Win Rate:</strong> ${winRate}</p>
          <p><strong>Final Capital:</strong> ${finalCapital} ${currency}</p>
          <p><strong>Total P&L:</strong> ${pnl} ${currency}</p>
          <p><strong>Max Drawdown:</strong> ${maxDrawdown}</p>
          <p><strong>Annualized Sharpe Ratio:</strong> ${sharpe}</p>
        </div>
      `;

      // Show graph if available
      if (result.graph_base64) {
        const img = new Image();
        img.src = 'data:image/png;base64,' + result.graph_base64;
        img.alt = 'Backtest Graph';
        img.style.maxWidth = '100%';
        document.getElementById("backtestResult").appendChild(img);
      }
    })
    .catch(error => {
      document.getElementById("backtestResult").innerHTML = `
        <div class="alert alert-danger">Error: ${error.message}</div>
      `;
    });
}



function clearBacktestResult() {
  document.getElementById("backtestResult").innerHTML = '';
}

document.getElementById("strategySelect").addEventListener("change", function () {
  const selected = this.value;
  const descriptionBox = document.getElementById("strategyDescription");

  if (strategyDescriptions[selected]) {
    descriptionBox.innerHTML = strategyDescriptions[selected];
  } else {
    descriptionBox.innerHTML = "<strong>Strategy Info:</strong> Please select a valid strategy.";
  }
});

// Auto-load on page load
document.addEventListener('DOMContentLoaded', function() {
    loadGreeks();
});
</script>
</body>
</html>